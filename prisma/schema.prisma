// Prisma Schema for Pink Post Installations
// PostgreSQL on Railway

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// NextAuth.js Models
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

// ============================================
// User Model (combines NextAuth User + Profile)
// ============================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  emailVerified   DateTime? @map("email_verified")
  password        String?   // Hashed password for credentials auth
  name            String?
  image           String?

  // Profile fields
  fullName        String?   @map("full_name")
  phone           String?
  company         String?
  role            UserRole  @default(customer)
  stripeCustomerId String?  @map("stripe_customer_id")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // NextAuth relations
  accounts        Account[]
  sessions        Session[]

  // Business relations
  orders          Order[]
  installations   Installation[]
  customerSigns   CustomerSign[]
  customerRiders  CustomerRider[]
  customerLockboxes CustomerLockbox[]
  customerBrochureBoxes CustomerBrochureBox[]
  paymentMethods  PaymentMethod[]
  serviceRequests ServiceRequest[]
  notifications   Notification[]
  promoCodeUsages PromoCodeUsage[]

  @@map("users")
}

enum UserRole {
  customer
  admin
}

// ============================================
// Notifications
// ============================================

model Notification {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  type        NotificationType
  title       String
  message     String
  link        String?          // Optional link to relevant page
  isRead      Boolean          @default(false) @map("is_read")
  createdAt   DateTime         @default(now()) @map("created_at")

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  order_confirmed
  order_scheduled
  order_in_progress
  order_completed
  order_cancelled
  service_request_acknowledged
  service_request_scheduled
  service_request_completed
  removal_reminder
  welcome
}

// ============================================
// Product Catalog
// ============================================

model PostType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  price       Decimal  @db.Decimal(10, 2)
  imageUrl    String?  @map("image_url")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  orders      Order[]

  @@map("post_types")
}

model RiderCatalog {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  rentalPrice Decimal  @db.Decimal(10, 2) @map("rental_price")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  customerRiders      CustomerRider[]
  installationRiders  InstallationRider[]
  orderItems          OrderItem[]

  @@map("rider_catalog")
}

model LockboxType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  rentalPrice Decimal? @db.Decimal(10, 2) @map("rental_price")
  installFee  Decimal  @db.Decimal(10, 2) @map("install_fee")
  isRentable  Boolean  @default(false) @map("is_rentable")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  customerLockboxes     CustomerLockbox[]
  installationLockboxes InstallationLockbox[]

  @@map("lockbox_types")
}

// ============================================
// Customer Inventory
// ============================================

model CustomerSign {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  description String
  imageUrl    String?  @map("image_url")
  inStorage   Boolean  @default(true) @map("in_storage")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("customer_signs")
}

model CustomerRider {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  riderId     String   @map("rider_id")
  isOwned     Boolean  @default(true) @map("is_owned")
  inStorage   Boolean  @default(true) @map("in_storage")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  rider       RiderCatalog @relation(fields: [riderId], references: [id])

  @@map("customer_riders")
}

model CustomerLockbox {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  lockboxTypeId String @map("lockbox_type_id")
  serialNumber String? @map("serial_number")
  code        String?
  isOwned     Boolean  @default(true) @map("is_owned")
  inStorage   Boolean  @default(true) @map("in_storage")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  lockboxType LockboxType @relation(fields: [lockboxTypeId], references: [id])

  @@map("customer_lockboxes")
}

model CustomerBrochureBox {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  description String?
  inStorage   Boolean  @default(true) @map("in_storage")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("customer_brochure_boxes")
}

// ============================================
// Orders
// ============================================

model Order {
  id                String        @id @default(cuid())
  orderNumber       String        @unique @map("order_number")
  userId            String        @map("user_id")
  postTypeId        String?       @map("post_type_id") // Optional - orders can be for other services only

  // Property info
  propertyAddress   String        @map("property_address")
  propertyCity      String        @map("property_city")
  propertyState     String        @default("KY") @map("property_state")
  propertyZip       String        @map("property_zip")
  propertyType      PropertyType  @default(residential) @map("property_type")
  propertyNotes     String?       @map("property_notes")
  installationLocationImage String? @map("installation_location_image") @db.Text

  // Installation details
  isGatedCommunity  Boolean       @default(false) @map("is_gated_community")
  gateCode          String?       @map("gate_code")
  hasMarkerPlaced   Boolean       @default(false) @map("has_marker_placed")
  signOrientation   String?       @map("sign_orientation")
  signOrientationOther String?    @map("sign_orientation_other")
  installationLocation String?    @map("installation_location")

  // Scheduling
  scheduledDate     DateTime?     @map("scheduled_date")
  isExpedited       Boolean       @default(false) @map("is_expedited")

  // Pricing
  subtotal          Decimal       @db.Decimal(10, 2)
  fuelSurcharge     Decimal       @default(2.47) @db.Decimal(10, 2) @map("fuel_surcharge")
  expediteFee       Decimal       @default(0) @db.Decimal(10, 2) @map("expedite_fee")
  discount          Decimal       @default(0) @db.Decimal(10, 2)
  tax               Decimal       @default(0) @db.Decimal(10, 2)
  total             Decimal       @db.Decimal(10, 2)

  // Promo Code
  promoCodeId       String?       @map("promo_code_id")

  // Status
  status            OrderStatus   @default(pending)
  paymentStatus     PaymentStatus @default(pending) @map("payment_status")
  paymentIntentId   String?       @map("payment_intent_id")
  paidAt            DateTime?     @map("paid_at")

  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  postType          PostType?     @relation(fields: [postTypeId], references: [id])
  promoCode         PromoCode?    @relation(fields: [promoCodeId], references: [id])
  orderItems        OrderItem[]
  installation      Installation?

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String   @map("order_id")
  itemType    String   @map("item_type")
  itemCategory String? @map("item_category") // 'storage', 'rental', 'new', 'owned'
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2) @map("unit_price")
  totalPrice  Decimal  @db.Decimal(10, 2) @map("total_price")

  // Optional references to customer inventory
  riderId              String?  @map("rider_id")
  customerRiderId      String?  @map("customer_rider_id")
  customerBrochureBoxId String? @map("customer_brochure_box_id")
  customerLockboxId    String?  @map("customer_lockbox_id")
  customerSignId       String?  @map("customer_sign_id")
  customValue          String?  @map("custom_value")

  createdAt   DateTime @default(now()) @map("created_at")

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  rider       RiderCatalog? @relation(fields: [riderId], references: [id])

  @@map("order_items")
}

enum PropertyType {
  residential
  commercial
  land
  multi_family
  house
  construction
  bare_land
}

enum OrderStatus {
  pending
  confirmed
  scheduled
  in_progress
  completed
  cancelled
}

enum PaymentStatus {
  pending
  processing
  succeeded
  failed
  refunded
}

// ============================================
// Installations
// ============================================

model Installation {
  id              String            @id @default(cuid())
  orderId         String            @unique @map("order_id")
  userId          String            @map("user_id")

  propertyAddress String            @map("property_address")
  propertyCity    String            @map("property_city")
  propertyState   String            @default("KY") @map("property_state")
  propertyZip     String            @map("property_zip")

  installedAt     DateTime          @default(now()) @map("installed_at")
  status          InstallationStatus @default(active)
  removalDate     DateTime?         @map("removal_date")
  removedAt       DateTime?         @map("removed_at")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  order           Order             @relation(fields: [orderId], references: [id])
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  riders          InstallationRider[]
  lockboxes       InstallationLockbox[]
  serviceRequests ServiceRequest[]

  @@map("installations")
}

model InstallationRider {
  id              String       @id @default(cuid())
  installationId  String       @map("installation_id")
  riderId         String       @map("rider_id")
  isRental        Boolean      @default(false) @map("is_rental")
  installedAt     DateTime     @default(now()) @map("installed_at")
  removedAt       DateTime?    @map("removed_at")

  installation    Installation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  rider           RiderCatalog @relation(fields: [riderId], references: [id])

  @@map("installation_riders")
}

model InstallationLockbox {
  id              String       @id @default(cuid())
  installationId  String       @map("installation_id")
  lockboxTypeId   String       @map("lockbox_type_id")
  isRental        Boolean      @default(false) @map("is_rental")
  code            String?
  installedAt     DateTime     @default(now()) @map("installed_at")
  removedAt       DateTime?    @map("removed_at")

  installation    Installation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  lockboxType     LockboxType  @relation(fields: [lockboxTypeId], references: [id])

  @@map("installation_lockboxes")
}

enum InstallationStatus {
  active
  removal_scheduled
  removed
}

// ============================================
// Service Requests
// ============================================

model ServiceRequest {
  id              String              @id @default(cuid())
  installationId  String              @map("installation_id")
  userId          String              @map("user_id")
  type            ServiceRequestType
  status          ServiceRequestStatus @default(pending)
  description     String?
  requestedDate   DateTime?           @map("requested_date")
  notes           String?
  adminNotes      String?             @map("admin_notes")
  completedAt     DateTime?           @map("completed_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  installation    Installation        @relation(fields: [installationId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("service_requests")
}

enum ServiceRequestType {
  removal
  service
  repair
  replacement
}

enum ServiceRequestStatus {
  pending
  acknowledged
  scheduled
  in_progress
  completed
  cancelled
}

// ============================================
// Payment Methods
// ============================================

model PaymentMethod {
  id                  String   @id @default(cuid())
  userId              String   @map("user_id")
  stripePaymentMethodId String @unique @map("stripe_payment_method_id")
  brand               String
  last4               String
  expMonth            Int      @map("exp_month")
  expYear             Int      @map("exp_year")
  isDefault           Boolean  @default(false) @map("is_default")
  createdAt           DateTime @default(now()) @map("created_at")

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_methods")
}

// ============================================
// Promo Codes
// ============================================

model PromoCode {
  id              String    @id @default(cuid())
  code            String    @unique
  description     String?
  discountType    DiscountType @default(percentage) @map("discount_type")
  discountValue   Decimal   @db.Decimal(10, 2) @map("discount_value") // percentage or fixed amount
  minOrderAmount  Decimal?  @db.Decimal(10, 2) @map("min_order_amount")
  maxUses         Int?      @map("max_uses") // Max uses per customer (null = unlimited)
  startsAt        DateTime? @map("starts_at")
  expiresAt       DateTime? @map("expires_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  orders          Order[]
  usages          PromoCodeUsage[]

  @@map("promo_codes")
}

// Tracks per-customer promo code usage
model PromoCodeUsage {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  promoCodeId String    @map("promo_code_id")
  usedAt      DateTime  @default(now()) @map("used_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@map("promo_code_usages")
}

enum DiscountType {
  percentage
  fixed
}
